 include/linux/rcuclassic.h |    3 +++
 include/linux/rcupreempt.h |    2 ++
 kernel/rcuclassic.c        |   19 ++++++++++++++++---
 kernel/rcupreempt.c        |    2 +-
 4 files changed, 22 insertions(+), 4 deletions(-)

Index: linux-2.6.26/include/linux/rcuclassic.h
===================================================================
--- linux-2.6.26.orig/include/linux/rcuclassic.h
+++ linux-2.6.26/include/linux/rcuclassic.h
@@ -161,4 +161,7 @@ extern long rcu_batches_completed_bh(voi
 #define rcu_enter_nohz()	do { } while (0)
 #define rcu_exit_nohz()		do { } while (0)
 
+struct softirq_action;
+extern void rcu_process_callbacks(struct softirq_action *unused);
+
 #endif /* __LINUX_RCUCLASSIC_H */
Index: linux-2.6.26/include/linux/rcupreempt.h
===================================================================
--- linux-2.6.26.orig/include/linux/rcupreempt.h
+++ linux-2.6.26/include/linux/rcupreempt.h
@@ -134,4 +134,6 @@ static inline void rcu_exit_nohz(void)
 #define rcu_exit_nohz()		do { } while (0)
 #endif /* CONFIG_NO_HZ */
 
+extern void rcu_process_callbacks(struct softirq_action *unused);
+
 #endif /* __LINUX_RCUPREEMPT_H */
Index: linux-2.6.26/kernel/rcuclassic.c
===================================================================
--- linux-2.6.26.orig/kernel/rcuclassic.c
+++ linux-2.6.26/kernel/rcuclassic.c
@@ -416,6 +416,8 @@ static void rcu_offline_cpu(int cpu)
 static void __rcu_process_callbacks(struct rcu_ctrlblk *rcp,
 					struct rcu_data *rdp)
 {
+	unsigned long flags;
+
 	if (rdp->curlist && !rcu_batch_before(rcp->completed, rdp->batch)) {
 		*rdp->donetail = rdp->curlist;
 		rdp->donetail = rdp->curtail;
@@ -424,12 +426,12 @@ static void __rcu_process_callbacks(stru
 	}
 
 	if (rdp->nxtlist && !rdp->curlist) {
-		local_irq_disable();
+		local_irq_save(flags);
 		rdp->curlist = rdp->nxtlist;
 		rdp->curtail = rdp->nxttail;
 		rdp->nxtlist = NULL;
 		rdp->nxttail = &rdp->nxtlist;
-		local_irq_enable();
+		local_irq_restore(flags);
 
 		/*
 		 * start the next batch of callbacks
@@ -456,7 +458,7 @@ static void __rcu_process_callbacks(stru
 		rcu_do_batch(rdp);
 }
 
-static void rcu_process_callbacks(struct softirq_action *unused)
+void rcu_process_callbacks(struct softirq_action *unused)
 {
 	__rcu_process_callbacks(&rcu_ctrlblk, &__get_cpu_var(rcu_data));
 	__rcu_process_callbacks(&rcu_bh_ctrlblk, &__get_cpu_var(rcu_bh_data));
@@ -511,6 +513,17 @@ int rcu_needs_cpu(int cpu)
 	return (!!rdp->curlist || !!rdp_bh->curlist || rcu_pending(cpu));
 }
 
+void rcu_advance_callbacks(int cpu, int user)
+{
+	if (user ||
+	    (idle_cpu(cpu) && !in_softirq() &&
+				hardirq_count() <= (1 << HARDIRQ_SHIFT))) {
+		rcu_qsctr_inc(cpu);
+		rcu_bh_qsctr_inc(cpu);
+	} else if (!in_softirq())
+		rcu_bh_qsctr_inc(cpu);
+}
+
 void rcu_check_callbacks(int cpu, int user)
 {
 	if (user ||
Index: linux-2.6.26/kernel/rcupreempt.c
===================================================================
--- linux-2.6.26.orig/kernel/rcupreempt.c
+++ linux-2.6.26/kernel/rcupreempt.c
@@ -944,7 +944,7 @@ void __cpuinit rcu_online_cpu(int cpu)
 	spin_unlock_irqrestore(&rcu_ctrlblk.fliplock, flags);
 }
 
-static void rcu_process_callbacks(struct softirq_action *unused)
+void rcu_process_callbacks(struct softirq_action *unused)
 {
 	unsigned long flags;
 	struct rcu_head *next, *list;
