From: Avi Kiviti <avi@qumranet.com>
Date: Tue, 15 Jan 2008 11:42:29 +0200
Subject: kvm: silence the printk noise

Will hit mainline in a modified way.

Signed-off-by: Avi Kiviti <avi@qumranet.com>
Signed-off-by: Thomas Gleixner <tgxl@linutronix.de>

---
 drivers/kvm/kvm.h      |    6 ++++++
 drivers/kvm/kvm_main.c |    4 ++--
 drivers/kvm/lapic.c    |   22 +++++++++++-----------
 3 files changed, 19 insertions(+), 13 deletions(-)

Index: linux-2.6.24-rt1/drivers/kvm/kvm.h
===================================================================
--- linux-2.6.24-rt1.orig/drivers/kvm/kvm.h	2008-01-25 15:07:06.000000000 -0500
+++ linux-2.6.24-rt1/drivers/kvm/kvm.h	2008-01-25 15:07:06.000000000 -0500
@@ -509,6 +509,7 @@ struct kvm_x86_ops {
 
 extern struct kvm_x86_ops *kvm_x86_ops;
 
+#ifdef KVM_DEBUG
 /* The guest did something we don't support. */
 #define pr_unimpl(vcpu, fmt, ...)					\
  do {									\
@@ -518,6 +519,11 @@ extern struct kvm_x86_ops *kvm_x86_ops;
  } while(0)
 
 #define kvm_printf(kvm, fmt ...) printk(KERN_DEBUG fmt)
+#else
+#define pr_unimpl(vcpu, fmt ...) do { } while(0)
+#define kvm_printf(kvm, fmt ...) do { } while(0)
+#endif
+
 #define vcpu_printf(vcpu, fmt...) kvm_printf(vcpu->kvm, fmt)
 
 int kvm_vcpu_init(struct kvm_vcpu *vcpu, struct kvm *kvm, unsigned id);
Index: linux-2.6.24-rt1/drivers/kvm/kvm_main.c
===================================================================
--- linux-2.6.24-rt1.orig/drivers/kvm/kvm_main.c	2008-01-25 15:07:06.000000000 -0500
+++ linux-2.6.24-rt1/drivers/kvm/kvm_main.c	2008-01-25 15:07:06.000000000 -0500
@@ -1987,8 +1987,8 @@ static int __vcpu_run(struct kvm_vcpu *v
 	int r;
 
 	if (unlikely(vcpu->mp_state == VCPU_MP_STATE_SIPI_RECEIVED)) {
-		printk("vcpu %d received sipi with vector # %x\n",
-		       vcpu->vcpu_id, vcpu->sipi_vector);
+		vcpu_printf(vcpu, "vcpu %d received sipi with vector # %x\n",
+			    vcpu->vcpu_id, vcpu->sipi_vector);
 		kvm_lapic_reset(vcpu);
 		kvm_x86_ops->vcpu_reset(vcpu);
 		vcpu->mp_state = VCPU_MP_STATE_RUNNABLE;
Index: linux-2.6.24-rt1/drivers/kvm/lapic.c
===================================================================
--- linux-2.6.24-rt1.orig/drivers/kvm/lapic.c	2008-01-25 15:07:06.000000000 -0500
+++ linux-2.6.24-rt1/drivers/kvm/lapic.c	2008-01-25 15:07:06.000000000 -0500
@@ -347,35 +347,35 @@ static int __apic_accept_irq(struct kvm_
 		break;
 
 	case APIC_DM_REMRD:
-		printk(KERN_DEBUG "Ignoring delivery mode 3\n");
+		vcpu_printf(vcpu "Ignoring delivery mode 3\n");
 		break;
 
 	case APIC_DM_SMI:
-		printk(KERN_DEBUG "Ignoring guest SMI\n");
+		vcpu_printf(vcpu, "Ignoring guest SMI\n");
 		break;
 	case APIC_DM_NMI:
-		printk(KERN_DEBUG "Ignoring guest NMI\n");
+		vcpu_printf(vcpu, "Ignoring guest NMI\n");
 		break;
 
 	case APIC_DM_INIT:
 		if (level) {
 			if (vcpu->mp_state == VCPU_MP_STATE_RUNNABLE)
-				printk(KERN_DEBUG
-				       "INIT on a runnable vcpu %d\n",
-				       vcpu->vcpu_id);
+				vcpu_printf(vcpu,
+					    "INIT on a runnable vcpu %d\n",
+					    vcpu->vcpu_id);
 			vcpu->mp_state = VCPU_MP_STATE_INIT_RECEIVED;
 			kvm_vcpu_kick(vcpu);
 		} else {
-			printk(KERN_DEBUG
-			       "Ignoring de-assert INIT to vcpu %d\n",
-			       vcpu->vcpu_id);
+			vcpu_printf(vcpu,
+				    "Ignoring de-assert INIT to vcpu %d\n",
+				    vcpu->vcpu_id);
 		}
 
 		break;
 
 	case APIC_DM_STARTUP:
-		printk(KERN_DEBUG "SIPI to vcpu %d vector 0x%02x\n",
-		       vcpu->vcpu_id, vector);
+		vcpu_printf(vcpu, "SIPI to vcpu %d vector 0x%02x\n",
+			    vcpu->vcpu_id, vector);
 		if (vcpu->mp_state == VCPU_MP_STATE_INIT_RECEIVED) {
 			vcpu->sipi_vector = vector;
 			vcpu->mp_state = VCPU_MP_STATE_SIPI_RECEIVED;
