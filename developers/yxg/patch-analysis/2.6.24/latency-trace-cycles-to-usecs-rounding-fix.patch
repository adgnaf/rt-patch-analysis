From dwalker@mvista.com Wed Dec 12 15:32:36 2007
Date: Wed, 12 Dec 2007 12:15:22 -0800
From: Daniel Walker <dwalker@mvista.com>
To: rostedt@goodmis.org
Cc: mingo@elte.hu, linux-kernel@vger.kernel.org, linux-rt-users@vger.kernel.org,
     johnstul@us.ibm.com
Subject: [PATCH -rt] cycles_to_usecs rounding fix

do_div() rounds down, so we add have the divisor to round up. This effected my
change to preempt_max_latency. Each time you read preempt_max_latency it gets 
rounded lower.

Signed-off-by: Daniel Walker <dwalker@mvista.com>


---
 kernel/time/timekeeping.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

Index: linux-2.6.24-rc5-rt1/kernel/time/timekeeping.c
===================================================================
--- linux-2.6.24-rc5-rt1.orig/kernel/time/timekeeping.c
+++ linux-2.6.24-rc5-rt1/kernel/time/timekeeping.c
@@ -121,7 +121,8 @@ unsigned long notrace cycles_to_usecs(cy
 {
 	u64 ret = cyc2ns(clock, cycles);
 
-	do_div(ret, 1000);
+	ret += NSEC_PER_USEC/2; /* For rounding in do_div() */
+	do_div(ret, NSEC_PER_USEC);
 
 	return ret;
 }
