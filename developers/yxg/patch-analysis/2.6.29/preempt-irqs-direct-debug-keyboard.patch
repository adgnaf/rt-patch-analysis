Subject: preempt: irqs direct debug keyboard
From: Ingo Molnar <mingo@elte.hu>
Date: Wed Feb 04 00:03:09 CET 2009

Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 include/linux/sched.h |    6 ++++++
 init/main.c           |    2 ++
 kernel/irq/handle.c   |   31 +++++++++++++++++++++++++++++++
 3 files changed, 39 insertions(+)

Index: linux-2.6-tip/include/linux/sched.h
===================================================================
--- linux-2.6-tip.orig/include/linux/sched.h
+++ linux-2.6-tip/include/linux/sched.h
@@ -305,6 +305,12 @@ extern void scheduler_tick(void);
 
 extern void sched_show_task(struct task_struct *p);
 
+#ifdef CONFIG_GENERIC_HARDIRQS
+extern int debug_direct_keyboard;
+#else
+# define debug_direct_keyboard 0
+#endif
+
 #ifdef CONFIG_DETECT_SOFTLOCKUP
 extern void softlockup_tick(void);
 extern void touch_softlockup_watchdog(void);
Index: linux-2.6-tip/init/main.c
===================================================================
--- linux-2.6-tip.orig/init/main.c
+++ linux-2.6-tip/init/main.c
@@ -897,5 +897,7 @@ static int __init kernel_init(void * unu
 	 */
 
 	init_post();
+	WARN_ON(debug_direct_keyboard);
+
 	return 0;
 }
Index: linux-2.6-tip/kernel/irq/handle.c
===================================================================
--- linux-2.6-tip.orig/kernel/irq/handle.c
+++ linux-2.6-tip/kernel/irq/handle.c
@@ -355,6 +355,11 @@ irqreturn_t handle_IRQ_event(unsigned in
 	irqreturn_t ret, retval = IRQ_NONE;
 	unsigned int status = 0;
 
+#ifdef __i386__
+	if (debug_direct_keyboard && irq == 1)
+		lockdep_off();
+#endif
+
 	/*
 	 * Unconditionally enable interrupts for threaded
 	 * IRQ handlers:
@@ -391,9 +396,30 @@ irqreturn_t handle_IRQ_event(unsigned in
 	}
 	local_irq_disable();
 
+#ifdef __i386__
+	if (debug_direct_keyboard && irq == 1)
+		lockdep_on();
+#endif
 	return retval;
 }
 
+/*
+ * Hack - used for development only.
+ */
+int __read_mostly debug_direct_keyboard = 0;
+
+int __init debug_direct_keyboard_setup(char *str)
+{
+	debug_direct_keyboard = 1;
+	printk(KERN_INFO "Switching IRQ 1 (keyboard) to to direct!\n");
+#ifdef CONFIG_PREEMPT_RT
+	printk(KERN_INFO "WARNING: kernel may easily crash this way!\n");
+#endif
+	return 1;
+}
+
+__setup("debug_direct_keyboard", debug_direct_keyboard_setup);
+
 int redirect_hardirq(struct irq_desc *desc)
 {
 	/*
@@ -403,6 +429,11 @@ int redirect_hardirq(struct irq_desc *de
 	    !desc->thread)
 		return 0;
 
+#ifdef __i386__
+	if (debug_direct_keyboard && (desc - irq_desc == 1))
+		return 0;
+#endif
+
 	BUG_ON(!irqs_disabled());
 	if (desc->thread && desc->thread->state != TASK_RUNNING)
 		wake_up_process(desc->thread);
