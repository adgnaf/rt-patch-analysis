Subject: patches/printk-in-atomic.patch


From: Clark Williams <williams@redhat.com>

Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 arch/x86/kernel/early_printk.c |    4 ++--
 drivers/char/vt.c              |    2 +-
 include/linux/console.h        |   11 +++++++++++
 kernel/printk.c                |    1 +
 4 files changed, 15 insertions(+), 3 deletions(-)

Index: linux-2.6-tip/arch/x86/kernel/early_printk.c
===================================================================
--- linux-2.6-tip.orig/arch/x86/kernel/early_printk.c
+++ linux-2.6-tip/arch/x86/kernel/early_printk.c
@@ -59,7 +59,7 @@ static void early_vga_write(struct conso
 static struct console early_vga_console = {
 	.name =		"earlyvga",
 	.write =	early_vga_write,
-	.flags =	CON_PRINTBUFFER,
+	.flags =	CON_PRINTBUFFER | CON_ATOMIC,
 	.index =	-1,
 };
 
@@ -156,7 +156,7 @@ static __init void early_serial_init(cha
 static struct console early_serial_console = {
 	.name =		"earlyser",
 	.write =	early_serial_write,
-	.flags =	CON_PRINTBUFFER,
+	.flags =	CON_PRINTBUFFER | CON_ATOMIC,
 	.index =	-1,
 };
 
Index: linux-2.6-tip/drivers/char/vt.c
===================================================================
--- linux-2.6-tip.orig/drivers/char/vt.c
+++ linux-2.6-tip/drivers/char/vt.c
@@ -2538,7 +2538,7 @@ static struct console vt_console_driver 
 	.write		= vt_console_print,
 	.device		= vt_console_device,
 	.unblank	= unblank_screen,
-	.flags		= CON_PRINTBUFFER,
+	.flags		= CON_PRINTBUFFER | CON_ATOMIC,
 	.index		= -1,
 };
 #endif
Index: linux-2.6-tip/include/linux/console.h
===================================================================
--- linux-2.6-tip.orig/include/linux/console.h
+++ linux-2.6-tip/include/linux/console.h
@@ -93,6 +93,17 @@ void give_up_console(const struct consw 
 #define CON_BOOT	(8)
 #define CON_ANYTIME	(16) /* Safe to call when cpu is offline */
 #define CON_BRL		(32) /* Used for a braille device */
+#define CON_ATOMIC	(64) /* Safe to call in PREEMPT_RT atomic */
+
+#ifdef CONFIG_PREEMPT_RT
+# define console_atomic_safe(con)		\
+	(((con)->flags & CON_ATOMIC) ||		\
+	 (!in_atomic() && !irqs_disabled()) ||	\
+	 (system_state != SYSTEM_RUNNING) ||	\
+	 oops_in_progress)
+#else
+# define console_atomic_safe(con) (1)
+#endif
 
 struct console {
 	char	name[16];
Index: linux-2.6-tip/kernel/printk.c
===================================================================
--- linux-2.6-tip.orig/kernel/printk.c
+++ linux-2.6-tip/kernel/printk.c
@@ -395,6 +395,7 @@ static void __call_console_drivers(unsig
 
 	for (con = console_drivers; con; con = con->next) {
 		if ((con->flags & CON_ENABLED) && con->write &&
+				console_atomic_safe(con) &&
 				(cpu_online(raw_smp_processor_id()) ||
 				 (con->flags & CON_ANYTIME))) {
 			set_printk_might_sleep(1);
