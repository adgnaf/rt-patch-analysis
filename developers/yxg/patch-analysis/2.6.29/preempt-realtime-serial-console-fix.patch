Subject: rt: serial console fix
From: Ingo Molnar <mingo@elte.hu>
Date: Tue Feb 10 00:10:12 CET 2009

The serial console printk path grew a new spinlock - which is rather
heavy - so instead of converting it to raw, use the sysrq/oops path
of only taking the lock if we can, on PREEMPT_RT.

Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 drivers/serial/8250.c   |    3 ++-
 include/linux/rt_lock.h |    3 +++
 2 files changed, 5 insertions(+), 1 deletion(-)

Index: linux-2.6-tip/drivers/serial/8250.c
===================================================================
--- linux-2.6-tip.orig/drivers/serial/8250.c
+++ linux-2.6-tip/drivers/serial/8250.c
@@ -30,6 +30,7 @@
 #include <linux/sysrq.h>
 #include <linux/delay.h>
 #include <linux/platform_device.h>
+#include <linux/rt_lock.h>
 #include <linux/tty.h>
 #include <linux/tty_flip.h>
 #include <linux/serial_reg.h>
@@ -2716,7 +2717,7 @@ serial8250_console_write(struct console 
 
 	touch_nmi_watchdog();
 
-	if (up->port.sysrq || oops_in_progress)
+	if (up->port.sysrq || oops_in_progress || preempt_rt)
 		locked = spin_trylock_irqsave(&up->port.lock, flags);
 	else
 		spin_lock_irqsave(&up->port.lock, flags);
Index: linux-2.6-tip/include/linux/rt_lock.h
===================================================================
--- linux-2.6-tip.orig/include/linux/rt_lock.h
+++ linux-2.6-tip/include/linux/rt_lock.h
@@ -15,6 +15,7 @@
 #include <linux/spinlock_types.h>
 
 #ifdef CONFIG_PREEMPT_RT
+# define preempt_rt 1
 /*
  * spinlocks - an RT mutex plus lock-break field:
  */
@@ -280,6 +281,8 @@ extern void  rt_downgrade_write(struct r
 #define rwsem_is_locked(rwsem) \
 	PICK_RWSEM_OP_RET(compat_rwsem_is_locked, rt_rwsem_is_locked, rwsem)
 
+#else
+# define preempt_rt 0
 #endif /* CONFIG_PREEMPT_RT */
 
 #endif
